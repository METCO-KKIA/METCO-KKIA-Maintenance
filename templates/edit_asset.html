<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Edit Asset Record</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      padding: 2rem;
      background-color: #f8f9fa;
    }
    .form-label {
      font-weight: 600;
    }
    .thumb-preview img {
      width: 80px;
      height: 80px;
      margin: 5px;
      border: 1px solid #ccc;
      padding: 2px;
      border-radius: 6px;
      object-fit: cover;
    }
    .timer-controls {
      display: flex;
      gap: 5px;
      margin-top: 5px;
    }
    .timer-controls input {
      width: 30%;
    }
  </style>
</head>
<body>
<div style="padding: 10px; background-color: #eef; border-top: 2px solid #ccc; border-bottom: 2px solid #ccc; font-family: Arial, sans-serif; font-size: 1rem; text-align: center;">
  ğŸ‘¤ User: <strong>{{ session_username }}</strong> |
  ğŸ¢ Company: <strong>{{ session_company }}</strong> |
  ğŸ­ Facility: <strong>{{ session_facility }}</strong> |
  â±ï¸ Logged in since: <strong>{{ session_login_time }}</strong> |
  </div>
    ğŸ¨ Designed by <strong>Ahmed Reda Ali</strong>
</div>  <div class="container">
    <h2 class="mb-4 text-center">Edit Asset Record</h2>
    <form id="editForm" enctype="multipart/form-data" class="needs-validation" novalidate>
      <div id="editFields" class="row g-3 mb-3"></div>
      <hr />
      <div class="row g-3 mb-3">
        <div class="col-md-6">
          <label class="form-label">ğŸ“· CM Images</label>
          <input type="file" class="form-control image-input" name="CM Images" multiple accept="image/*" />
          <div class="thumb-preview" id="cm_images_preview"></div>
        </div>
        <div class="col-md-6">
          <label class="form-label">ğŸ§‰ Spare Parts Images</label>
          <input type="file" class="form-control image-input" name="Spare Parts Images" multiple accept="image/*" />
          <div class="thumb-preview" id="spare_parts_images_preview"></div>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Notes</label>
        <textarea class="form-control" name="notes_text" rows="4" placeholder="Enter notes..."></textarea>
      </div>

      <input type="hidden" name="sheet_name" id="sheetName" />
      <input type="hidden" name="row_index" id="rowIndex" />
      <input type="hidden" name="type" value="Asset" />

      <div class="text-end">
        <button type="submit" class="btn btn-success px-4">Save</button>
        <a href="/" class="btn btn-secondary px-4 ms-2">Back</a>
      </div>
    </form>
  </div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  const predefinedFields = [
    "DATE", "Ticket No", "Location (Issue)", "Description (Action)",
    "Start time", "Traget finish", "end time",
    "Attended by", "Facility", "Status", "Remark"
  ];

  const datetimeFields = ["DATE", "Start time", "Traget finish", "end time"];

  function formatDateInput(date) {
    const pad = n => n.toString().padStart(2, '0');
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
  }

  function createField(name, value) {
    const id = `field_${name.replace(/\s+/g, '_')}`;
    const type = datetimeFields.includes(name) ? 'datetime-local' : 'text';
    const safeValue = `value="${value && value.trim() !== '' ? value : '.'}"`;
    const isTragetFinish = name === "Traget finish";

    const priorityDropdown = isTragetFinish ? `
      <label class="form-label mt-2">Priority</label>
      <select class="form-select priority-select" data-target="${id}">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© --</option>
        <option value="Priority1">Priority 1</option>
        <option value="Priority2">Priority 2</option>
        <option value="Priority3">Priority 3</option>
        <option value="Priority5">Priority 5</option>
        <option value="Priority6">Priority 6</option>
      </select>` : '';

    const timerControls = datetimeFields.includes(name) ? `
      <div class="timer-controls">
        <input type="number" class="form-control timer-day" placeholder="Days" data-field="${name}">
        <input type="number" class="form-control timer-hour" placeholder="Hours" data-field="${name}">
        <input type="number" class="form-control timer-minute" placeholder="Minutes" data-field="${name}">
      </div>` : '';

    return `
      <div class="col-md-6">
        <label for="${id}" class="form-label">${name}</label>
        <input type="${type}" class="form-control" id="${id}" name="field_${name}" ${safeValue} required />
        <div class="invalid-feedback">Required</div>
        ${priorityDropdown}
        ${timerControls}
      </div>`;
  }

  function readQueryParams() {
    const urlParams = new URLSearchParams(window.location.search);
    return {
      sheet: urlParams.get('sheet'),
      row: urlParams.get('row')
    };
  }

  function showImagePreviews(input, targetId) {
    const preview = $(`#${targetId}`);
    preview.empty();
    Array.from(input.files).forEach(file => {
      const reader = new FileReader();
      reader.onload = e => {
        preview.append(`<img src="${e.target.result}" alt="preview" />`);
      };
      reader.readAsDataURL(file);
    });
  }

  $(document).ready(function () {
    const params = readQueryParams();
    console.log("ğŸ“¦ Params:", params);
    $('#sheetName').val(params.sheet);
    $('#rowIndex').val(params.row);

    $.get('/get_record', {
      type: 'Asset',
      sheet: params.sheet,
      row: params.row
    }, function (res) {
      console.log("âœ… Response from /get_record:", res);
      const container = $('#editFields');
      const raw = res.data || {};
      const now = new Date();

      const defaultValues = {
        "DATE": formatDateInput(now),
        "Ticket No": "00000",
        "Location (Issue)": raw["Location"] || "",
        "Description (Action)": raw["Asset Description"] || "",
        "Start time": formatDateInput(now),
        "Traget finish": formatDateInput(new Date(now.getTime() + 15 * 60000)),
        "end time": formatDateInput(now),
        "Attended by": "{{ session_username }} - {{ session_company }}",
        "Facility": "{{ session_facility }}",
        "Status": "completed",
        "Remark": "no comment"
      };

      container.empty();

      predefinedFields.forEach(name => {
        const val = raw[name] || defaultValues[name] || '';
        container.append(createField(name, val));
      });

      for (const key in raw) {
        if (!predefinedFields.includes(key)) {
          container.append(createField(key, raw[key]));
        }
      }
    }).fail(function (err) {
      console.error("âŒ Failed to fetch record:", err);
    });

    $(document).on('change', '.priority-select', function () {
      const selected = $(this).val();
      const targetId = $(this).data('target');
      const now = new Date();
      let futureTime = new Date(now);

      switch (selected) {
        case 'Priority1': futureTime.setMinutes(futureTime.getMinutes() + 30); break;
        case 'Priority2': futureTime.setHours(futureTime.getHours() + 2); break;
        case 'Priority3': futureTime.setHours(futureTime.getHours() + 24); break;
        case 'Priority5': futureTime.setDate(futureTime.getDate() + 2); break;
        case 'Priority6': futureTime.setDate(futureTime.getDate() + 4); break;
        default: return;
      }

      const pad = n => n.toString().padStart(2, '0');
      const formatted = `${futureTime.getFullYear()}-${pad(futureTime.getMonth() + 1)}-${pad(futureTime.getDate())}T${pad(futureTime.getHours())}:${pad(futureTime.getMinutes())}`;
      $(`#${targetId}`).val(formatted);
    });

    $('.image-input').on('change', function () {
      const name = $(this).attr('name').toLowerCase().replace(/\s+/g, '_');
      showImagePreviews(this, `${name}_preview`);
    });

    $('#editForm').on('submit', function (e) {
      e.preventDefault();
      const form = this;

      if (!form.checkValidity()) {
        e.stopPropagation();
        form.classList.add('was-validated');
        return;
      }
// âœ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø²Ù…Ù†ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§ÙŠÙ…Ø±Ø§Øª
$('.timer-controls').each(function () {
  const day = parseInt($(this).find('.timer-day').val()) || 0;
  const hour = parseInt($(this).find('.timer-hour').val()) || 0;
  const minute = parseInt($(this).find('.timer-minute').val()) || 0;

  const fieldName = $(this).find('input').first().data('field');
  const field = $(`#field_${fieldName.replace(/\s+/g, '_')}`);
  const baseTime = new Date(field.val());

  if (!isNaN(baseTime.getTime())) {
    baseTime.setDate(baseTime.getDate() + day);
    baseTime.setHours(baseTime.getHours() + hour);
    baseTime.setMinutes(baseTime.getMinutes() + minute);

    const pad = n => n.toString().padStart(2, '0');
    const formatted = `${baseTime.getFullYear()}-${pad(baseTime.getMonth() + 1)}-${pad(baseTime.getDate())}T${pad(baseTime.getHours())}:${pad(baseTime.getMinutes())}`;
    field.val(formatted);
  }
});

      $('#editForm input[type="datetime-local"]').each(function () {
        const val = this.value;
        if (val) {
          const date = new Date(val);
          if (!isNaN(date)) {
            const pad = n => n.toString().padStart(2, '0');
            const formatted = `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
            this.value = formatted;
          }
        }
      });

      const formData = new FormData(form);

      $.ajax({
        type: 'POST',
        url: '/save_asset_edit',
        data: formData,
        contentType: false,
        processData: false,
        success: function (response) {
          try {
            if (typeof response === 'string' && response.includes("<!DOCTYPE html")) {
              const ticket = $('#field_Ticket_No').val() || "Unknown";
              const serial = $('#field_Serial_No').val() || "Unknown";
              const targetFinish = $('#field_Traget_finish').val();

              if (targetFinish) {
                const expiresAt = new Date(targetFinish).getTime();
                if (!isNaN(expiresAt)) {
                  const timers = JSON.parse(localStorage.getItem("timers") || "[]");
                  timers.push({
                    ticket: ticket,
                    serial: serial,
                    field: "Traget finish",
                    expiresAt: expiresAt,
                    expired: false
                  });
                  localStorage.setItem("timers", JSON.stringify(timers));
                  console.log("âœ… Timer added manually to localStorage.");
                }
              }

              document.open();
              document.write(response);
              document.close();
            } else {
              alert('âœ… Record saved successfully!');
              window.location.href = '/';
            }
          } catch (err) {
            console.error("âŒ Error inside success handler:", err);
            alert('âš ï¸ An error occurred after saving. Please check console.');
          }
        },
        error: function () {
          alert('âŒ Error saving record.');
        }
      });
    });
  });
</script>
</body>
</html>
