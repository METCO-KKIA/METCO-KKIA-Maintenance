<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Team Chat + UNO + Puzzle</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #chat-box {
      height: 400px;
      overflow-y: auto;
      background-color: #f7f7f7;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .message {
      margin: 5px 0;
      padding: 8px;
      border-radius: 8px;
      background: #e1f5fe;
    }
    .message.you {
      background: #dcedc8;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .top-bar .btn-group {
      display: flex;
      gap: 10px;
    }
    .uno-card {
      width: 60px;
      height: 90px;
      border-radius: 10px;
      color: white;
      font-weight: bold;
      font-size: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    .red { background-color: crimson; }
    .green { background-color: green; }
    .blue { background-color: royalblue; }
    .yellow { background-color: goldenrod; }

    #puzzle-board {
      margin: auto;
      margin-top: 20px;
      width: 600px;
      height: 400px;
      position: relative;
      border: 2px dashed #aaa;
      background-color: #fff;
    }
    .puzzle-piece {
      position: absolute;
      cursor: grab;
      border: 1px solid #ccc;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
      border-radius: 8px;
      background-size: 600px 400px;
    }
    #win-message {
      display: none;
      font-size: 1.5rem;
      color: green;
      margin-top: 20px;
    }
  </style>
</head>
<body class="container mt-4">
<div style="padding: 10px; background-color: #eef; border-top: 2px solid #ccc; border-bottom: 2px solid #ccc; font-family: Arial, sans-serif; font-size: 1rem; text-align: center;">
  ğŸ‘¤ User: <strong>{{ session_username }}</strong> |
  ğŸ¢ Company: <strong>{{ session_company }}</strong> |
  ğŸ­ Facility: <strong>{{ session_facility }}</strong> |
  â±ï¸ Logged in since: <strong>{{ session_login_time }}</strong> |
  </div>
    ğŸ¨ Designed by <strong>Ahmed Reda Ali</strong>
</div>

  <div class="top-bar">
    <h3>ğŸ’¬ Team Chat</h3>
    <div class="btn-group">
      <a href="{{ url_for('index') }}" class="btn btn-success">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <form action="{{ url_for('logout') }}" method="post" style="display:inline;">
        <button class="btn btn-danger">ğŸšª Logout</button>
      </form>
    </div>
  </div>

  <div id="chat-box">
    {% for msg in messages %}
      <div class="message{% if msg['username'] == username %} you{% endif %}">
        <strong>{{ msg['username'] }}:</strong>
        {{ msg['message'] }}
      </div>
    {% endfor %}
  </div>

  <form id="chat-form">
    <div class="input-group mb-2">
      <textarea id="chat-input" class="form-control" placeholder="Type a message..." rows="10" style="resize: vertical; max-height: 400px;"></textarea>
      <button type="submit" class="btn btn-primary">Send</button>
    </div>
    <div class="mb-2">
      <button type="button" class="btn btn-warning" id="record-btn">ğŸ™ï¸ Record Voice</button>
    </div>
    <div class="input-group mb-2">
      <input type="file" id="image-input" accept="image/*" class="form-control">
      <button type="button" class="btn btn-secondary" id="send-image-btn">Send Image</button>
    </div>
  </form>

  <audio id="notification-sound" src="{{ url_for('static', filename='gta.mp3') }}"></audio>

  <!-- UNO Game -->
  <div class="mt-5" id="uno-game">
    <h5>ğŸ´ UNO Game</h5>
    <div><strong>Top Card:</strong>
      <div id="uno-top-card" style="margin: 10px 0; padding: 15px; border: 2px dashed #aaa; border-radius: 8px; min-width: 80px; display: inline-block;"></div>
    </div>
    <div><strong>Your Hand:</strong>
      <div id="uno-hand" style="display: flex; gap: 10px; margin-top: 10px;"></div>
    </div>
    <div class="mt-3">
      <button class="btn btn-warning" id="uno-draw">ğŸƒ Draw Card</button>
    </div>
  </div>

  <!-- Puzzle Game -->
  <div class="mt-5">
    <h5>ğŸ§© Puzzle Game</h5>
    <div id="puzzle-board"></div>
    <div id="win-message">ğŸ‰ Puzzle Completed!</div>
  </div>

  <script>
    const socket = io();
    const username = "{{ username }}";

    const chatBox = document.getElementById('chat-box');
    const chatInput = document.getElementById('chat-input');
    const chatForm = document.getElementById('chat-form');
    const sound = document.getElementById('notification-sound');

    function playSound() {
      sound.currentTime = 0;
      sound.play();
    }

    function linkify(text) {
      const urlRegex = /((https?:\/\/|www\.)[^\s]+)/g;
      return text.replace(urlRegex, url => {
        const href = url.startsWith('http') ? url : 'http://' + url;
        return `<a href="${href}" target="_blank" rel="noopener noreferrer">${url}</a>`;
      });
    }

    function addMessage(user, message) {
      const div = document.createElement('div');
      div.className = 'message' + (user === username ? ' you' : '');
      div.innerHTML = `<strong>${user}:</strong><br><span style="white-space: pre-wrap;">${linkify(message)}</span>`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addAudioMessage(user, audioData) {
      const div = document.createElement('div');
      div.className = 'message' + (user === username ? ' you' : '');
      div.innerHTML = `<strong>${user}:</strong><br><audio controls src="${audioData}" style="width: 100%;"></audio>`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function addImageMessage(user, imageData) {
      const div = document.createElement('div');
      div.className = 'message' + (user === username ? ' you' : '');
      div.innerHTML = `<strong>${user}:</strong><br><img src="${imageData}" style="max-width: 100%; border-radius: 8px;">`;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    socket.on('receive_message', function(data) {
      if (data.audio) {
        addAudioMessage(data.user, data.audio);
      } else if (data.image) {
        addImageMessage(data.user, data.image);
      } else {
        addMessage(data.user, data.message);
      }
      if (data.user !== username) playSound();
    });

    chatForm.onsubmit = function(e) {
      e.preventDefault();
      const message = chatInput.value.trim();
      if (message) {
        socket.emit('send_message', { user: username, message });
        addMessage(username, message);
        playSound();
        chatInput.value = '';
      }
    };

    document.getElementById('send-image-btn').addEventListener('click', () => {
      const file = document.getElementById('image-input').files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = () => {
          socket.emit('send_message', { user: username, image: reader.result });
          addImageMessage(username, reader.result);
        };
        reader.readAsDataURL(file);
      }
    });

    let mediaRecorder;
    let audioChunks = [];

    document.getElementById('record-btn').addEventListener('click', async () => {
      if (!mediaRecorder || mediaRecorder.state === 'inactive') {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const reader = new FileReader();
          reader.onloadend = () => {
            const base64Audio = reader.result;
            socket.emit('send_message', { user: username, audio: base64Audio });
            addAudioMessage(username, base64Audio);
          };
          reader.readAsDataURL(blob);
        };
        document.getElementById('record-btn').textContent = 'ğŸ›‘ Stop Recording';
      } else {
        mediaRecorder.stop();
        document.getElementById('record-btn').textContent = 'ğŸ™ï¸ Record Voice';
      }
    });

    const unoColors = ['red', 'green', 'blue', 'yellow'];
    let unoHand = [];
    let unoTopCard = null;

    function generateCard() {
      const color = unoColors[Math.floor(Math.random() * unoColors.length)];
      const number = Math.floor(Math.random() * 10);
      return { color, number };
    }

    function renderUnoHand() {
      const handDiv = document.getElementById('uno-hand');
      handDiv.innerHTML = '';
      unoHand.forEach((card, index) => {
        const el = document.createElement('div');
        el.className = `uno-card ${card.color}`;
        el.textContent = card.number;
        el.onclick = () => playUnoCard(index);
        handDiv.appendChild(el);
      });
    }

    function updateTopCard(card) {
      unoTopCard = card;
      const topEl = document.getElementById('uno-top-card');
      topEl.className = `uno-card ${card.color}`;
      topEl.textContent = card.number;
    }

    function playUnoCard(index) {
      const card = unoHand[index];
      if (card.color === unoTopCard.color || card.number === unoTopCard.number) {
        unoHand.splice(index, 1);
        updateTopCard(card);
        renderUnoHand();
      } else {
        alert("Invalid move! Card must match color or number.");
      }
    }

    document.getElementById('uno-draw').addEventListener('click', () => {
      const newCard = generateCard();
      unoHand.push(newCard);
      renderUnoHand();
    });

    function initUnoGame() {
      unoHand = Array.from({ length: 5 }, generateCard);
      updateTopCard(generateCard());
      renderUnoHand();
    }

    initUnoGame();

    // Puzzle Game
    const imageSrc = "https://images.unsplash.com/photo-1606787366850-de6330128bfc?fit=crop&w=600&h=400";
    const board = document.getElementById('puzzle-board');
    const rows = 4, cols = 6;
    const pieceWidth = 100, pieceHeight = 100;
    const pieces = [];

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function createPuzzle() {
      let positions = [];
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          positions.push({ x, y });
        }
      }
      shuffleArray(positions);

      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          const div = document.createElement('div');
          div.classList.add('puzzle-piece');
          div.style.width = pieceWidth + 'px';
          div.style.height = pieceHeight + 'px';
          div.dataset.correctX = x;
          div.dataset.correctY = y;

          const pos = positions.pop();
          div.style.left = pos.x * pieceWidth + 'px';
          div.style.top = pos.y * pieceHeight + 'px';
          div.style.backgroundImage = `url(${imageSrc})`;
          div.style.backgroundPosition = `-${x * pieceWidth}px -${y * pieceHeight}px`;

          makeDraggable(div);
          board.appendChild(div);
          pieces.push(div);
        }
      }
    }

    function makeDraggable(piece) {
      let offsetX, offsetY, isDragging = false;

      piece.addEventListener('mousedown', e => {
        isDragging = true;
        offsetX = e.offsetX;
        offsetY = e.offsetY;
        piece.style.zIndex = 1000;
      });

      document.addEventListener('mousemove', e => {
        if (isDragging) {
          piece.style.left = e.pageX - board.offsetLeft - offsetX + 'px';
          piece.style.top = e.pageY - board.offsetTop - offsetY + 'px';
        }
      });

      document.addEventListener('mouseup', () => {
        if (!isDragging) return;
        isDragging = false;
        piece.style.zIndex = 1;
        snapToGrid(piece);
        checkWin();
      });
    }

    function snapToGrid(piece) {
      const left = parseInt(piece.style.left);
      const top = parseInt(piece.style.top);
      const snappedX = Math.round(left / pieceWidth);
      const snappedY = Math.round(top / pieceHeight);
      piece.style.left = snappedX * pieceWidth + 'px';
      piece.style.top = snappedY * pieceHeight + 'px';
    }

    function checkWin() {
      let correct = 0;
      pieces.forEach(piece => {
        const left = parseInt(piece.style.left) / pieceWidth;
        const top = parseInt(piece.style.top) / pieceHeight;
        if (parseInt(piece.dataset.correctX) === left && parseInt(piece.dataset.correctY) === top) {
          correct++;
        }
      });
      if (correct === rows * cols) {
        document.getElementById('win-message').style.display = 'block';
      }
    }

    createPuzzle();
  </script>
</body>
</html>
